var extend=require("extend"),runSequence=require("run-sequence"),fs=require("fs"),chmod=require("gulp-chmod"),moment=require("moment"),less=require("gulp-less"),cssmin=require("gulp-cssmin"),csscomb=require("gulp-csscomb"),autoprefixer=require("gulp-autoprefixer"),concat=require("gulp-concat"),header=require("gulp-header"),uglify=require("gulp-uglify"),rename=require("gulp-rename"),change=require("gulp-change"),sourcemaps=require("gulp-sourcemaps"),prettify=require("gulp-jsbeautifier"),mkdirp=require("mkdirp"),del=require("del"),format=require("string-format").extend(String.prototype),colors=require("colors"),gulp=require("gulp"),jsonminify=require("gulp-jsonminify"),zui=require("./zui.json"),pkg=require("./package.json"),showFileDetail=true;gulp.setMaxListeners(0);extend(true,zui,require("./zui.templates.json"));try{var zuicustom=require("./zui.custom.json");if(zuicustom){extend(true,zui,zuicustom)}}catch(e){}var today=moment();var typeSet=["less","js","resource"],lib=zui.lib,builds=zui.builds,BANNER=("/*!\n * {title} - v{version} - {date}\n * {homepage}\n * GitHub: {repo} \n * Copyright (c) {year} {author}; Licensed {license}\n */\n\n"),BANNER_OPTONS={title:pkg.title||pkg.name,version:pkg.version,date:today.format("YYYY-MM-DD"),homepage:pkg.homepage,repo:pkg.repository.url,year:today.format("YYYY"),author:pkg.author,license:pkg.license},BOOTSTRAP_STATEMENT="/*! Some code copy from Bootstrap v3.0.0 by @fat and @mdo. (Copyright 2013 Twitter, Inc. Licensed under http://www.apache.org/licenses/)*/\n\n";function formatBanner(a){if(a&&a.title){a.title=BANNER_OPTONS.title+": "+a.title}a=Object.assign({},BANNER_OPTONS,a);return BANNER.format(a)}function tryStatSync(b){try{return fs.statSync(b)}catch(a){return false}}function isFileExist(b){var a=tryStatSync(b);return a&&a.isFile()}function getItemList(d,a,b,f){a=a||[];if(Array.isArray(d)){d.forEach(function(g){if(g==="basic"&&f){return}getItemList(g,a,b,f)})}else{if(!(d==="basic"&&f)){var c=lib[d];if(c&&a.indexOf(d)<0){if(!b&&c.dpds){getItemList(c.dpds,a,b,f)}if(c.libDpds){getItemList(c.libDpds,a,b,f)}if(c.src){a.push(d)}}}}return a}function getBuildSource(c){var b=[];var a={less:[],js:[],resource:[]};if(!Array.isArray(b)){b=[b]}if(c.settingDpds){b=getItemList(c.settingDpds,b)}b=getItemList(c.includes,b,c.ignoreDpds,c.ignoreBasic);b.forEach(function(f){var d=lib[f];if(d&&d.src){typeSet.forEach(function(g){if(d.src[g]){d.src[g].forEach(function(h){if(a[g].indexOf(h)<0){a[g].push(h)}})}})}});return a}function getSourceConfig(b){var a=b.lastIndexOf("//");if(a>0){return{base:b.substr(0,a+1),src:b.replace(/\/\//g,"/"),file:b.substr(a+2)}}a=b.lastIndexOf("/");return{base:b.substr(0,a+1),src:b,file:b.substr(a+1)}}function getBuildPath(c,a){var b=c.dest;if(c.subdirectories){b+="/"+a+"/"}if(b.indexOf(".")!==0){b="./"+b}return b.replace(/\/\//g,"/").replace(/\/\//g,"/")}function getBuildDestFilename(d,b,c){var a=getBuildPath(d,b);a+="/"+d.filename+"."+(c||b);return a.replace(/\/\//g,"/")}function gulpBuildColorsetJS(d,c,f){var b="build:"+d.name;var a=getBuildPath(d,"js");return gulp.src(c).pipe(less()).pipe(rename({extname:".js"})).pipe(change(function(h,g){h=h.replace(/\/\*\*/g,"").replace(/\*\*\//g,"");h=h.replace(/\.color-(\w+) \{\n  color: (#?\w+);\n\}/g,"        $1: '$2',");h=h.replace(",\n    };","\n    };");h=h.replace("\n\n","\n");g(null,h)})).pipe(header(f)).pipe(gulp.dest(a)).on("end",function(){console.log("     js > ".yellow.bold+(a+d.filename+".js").italic.underline)})}function buildBundle(b,o,i){b=b||"all";var n=builds[b];var h=[],d=[];if(!i&&b==="dist"){del.sync("./dist/**/*")}else{if(!i&&b==="doc"){del.sync(["./docs/js/**/*","./docs/css/**/*","./docs/fonts/**/*"])}}if(!n){if(b==="all"){console.log("           ========== BUILD ALL ==========".blue.bold);var l=Object.keys(builds);l.forEach(function(r){n=builds[r];if(n&&!n.bundles){var q="build:"+r;gulp.task(q,function(s){buildBundle(r,s,i)});h.push(q)}});if(h.length){runSequence(h,function(){console.log(("        √  Build "+"ALL".bold+" success! ").green);o&&o()})}return}else{var g=lib[b];if(g){n={title:g.name,dest:"dist/lib/"+b+"/",filename:g.filename||((g.source&&g.source!=="Bootstrap")?b:("zui."+b)),includes:[b],source:g.source,settingDpds:(g.src&&g.src.less&&g.src.less.length)?["setting"]:null,ignoreBasic:true,ignoreDpds:g.ignoreDpds!==undefined?g.ignoreDpds:true}}else{console.log(("           Cannot found the build config: "+b).red);return false}}}else{if(n.bundles){console.log(("           === BUILD BUNDLES "+b.toUpperCase()+" ["+n.bundles.join(", ")+"] ===").blue.bold);var p=[];n.bundles.forEach(function(q){gulp.task("build:"+q,function(r){buildBundle(q,r,i)});p.push("build:"+q)});gulp.task("build:"+b+":bundles",function(q){runSequence(p,function(){console.log(("         √ Build BUNDLES "+b.toUpperCase()+" ["+n.bundles.map(function(r){return r.bold}).join(", ")+"] success! ").green);q()})});d.push("build:"+b+":bundles")}}if(n.preBuilds){n.preBuilds.forEach(function(q){var r=builds[q];if(r&&r.includes){n.includes=r.includes.concat(n.includes)}})}if(n.includes&&n.includes.indexOf("colorset.js")>-1){gulp.task("build:colorset.less2js",function(q){buildBundle("colorset.less2js",q,"less")});d.push("build:colorset.less2js")}console.log(("           --- build "+b+" ---").cyan.bold);var k=formatBanner({title:n.title||b});var a=getBuildSource(n),c=(n.source&&n.source!=="Bootstrap")?"":k+(n.bootstrapStatement?BOOTSTRAP_STATEMENT:"");if(a.js&&a.js.length&&(!i||i==="js")){console.log(("         + Ready to process "+a.js.length+" javascript files.").bold);a.js.forEach(function(r,q){if(r.indexOf("~/")===0){a.js[q]=r="src/js/"+r.substr(2)}if(showFileDetail){console.log(("         | "+r).italic)}});gulp.task("build:"+b+":js",function(){var q=getBuildPath(n,"js");return gulp.src(a.js).pipe(concat(n.filename+".js")).pipe(header(c)).pipe(chmod(644)).pipe(gulp.dest(q)).on("end",function(){console.log("      js > ".yellow.bold+(q+n.filename+".js").italic.underline)}).pipe(uglify({preserveComments:"some"})).pipe(rename({suffix:".min"})).pipe(chmod(644)).pipe(gulp.dest(q)).on("end",function(){console.log("      js > ".yellow.bold+(q+n.filename+".min.js").italic.underline)})});h.push("build:"+b+":js")}if(a.less&&a.less.length&&(!i||i==="less")){var j="// \n// "+n.title+"\n// Build config: "+b+"\n//\n// This file generated by ZUI builder automatically at "+today.toString()+".\n//\n\n";console.log(("         + Ready to process "+a.less.length+" less files.").bold);a.less.forEach(function(r,q){if(r.indexOf("~/")===0){a.less[q]=r="src/less/"+r.substr(2)}if(isFileExist(r)){j+='@import "';j+="../../"+r;j+='";\n';if(showFileDetail){console.log(("         | "+r).italic)}}else{j+='// @import "';j+="../../"+r;j+='" // FILE NOT FOUND;\n';if(showFileDetail){console.log(("         - "+r+" [NOT FOUND]").red.italic)}}});gulp.task("build:"+b+":less",function(){var r="./build/less/"+n.filename+".less";var q=getBuildPath(n,"css");mkdirp.sync("./build/less/");fs.writeFileSync(r,j);if(b==="colorset.less2js"){return gulpBuildColorsetJS(n,r,c)}return gulp.src(r).pipe(less()).pipe(autoprefixer({browsers:["Android 2.3","Android >= 4","Chrome >= 20","Firefox >= 24","Explorer >= 8","iOS >= 6","Opera >= 12","Safari >= 6"],cascade:true})).pipe(csscomb()).pipe(header(c)).pipe(chmod(644)).pipe(gulp.dest(q)).on("end",function(){console.log("     css > ".yellow.bold+(q+n.filename+".css").italic.underline)}).pipe(cssmin({compatibility:"ie8",keepSpecialComments:"*",sourceMap:true,advanced:false})).pipe(rename({suffix:".min"})).pipe(chmod(644)).pipe(gulp.dest(q)).on("end",function(){console.log("     css > ".yellow.bold+(q+n.filename+".min.css").italic.underline)})});h.push("build:"+b+":less")}if(a.resource&&a.resource.length&&(!i||i==="resource")){console.log(("         + Ready to process "+a.resource.length+" resource files.").bold);var f=getBuildPath(n,"");a.resource.forEach(function(r,q){if(r.indexOf("~/")===0){a.resource[q]=r="src//"+r.substr(2)}if(showFileDetail){console.log(("         | ["+q+"] "+r).italic)}gulp.task("build:"+b+":resource:"+q,function(){var s=getSourceConfig(r);return gulp.src(s.src,{base:s.base}).pipe(chmod(644)).pipe(gulp.dest(f)).on("end",function(){console.log("resource > ".yellow.bold+(f+s.file).italic.underline)})});h.push("build:"+b+":resource:"+q)})}if(h.length||d.length){var m=function(){console.log(("         √ Build "+b.bold+" success! ").green);o&&o()};if(h.length){if(d.length){runSequence(d,h,m)}else{runSequence(h,m)}}else{runSequence(d,m)}}else{console.log(("           No source files for build: "+b).red);o&&o()}}gulp.task("build",function(c){var a=process.argv[3]||"dist";if(a&&a[0]==="-"){a=a.substr(1)}if(a==="lib"){a="seperate"}var b=process.argv.length>4?process.argv[4]:false;if(b&&b[0]==="-"){b=b.substr(1)}console.log("  BEGIN >> "+(" Build "+a.bold+" ").inverse);buildBundle(a,function(){console.log("    END >> "+(" Build "+a.bold+" completed :)").green.inverse)},b)});function startWatchSrc(a){if(a==="lib"){a="seperate"}var c=builds[a];var b=c&&c.srcDir||"./src";gulp.watch([b+"/less/**/*"],function(d){buildBundle(a,function(){console.log("         √ ".green+(" WATCH "+a.bold+" COMPLETED. ").yellow.inverse)},"less")});gulp.watch([b+"/js/**/*"],function(d){if(d.path&&(d.path.lastIndexOf("src/js/colorset.js")>-1)||d.path.lastIndexOf("src\\js\\colorset.js")>-1){return}buildBundle(a,function(){console.log("         √ ".green+(" WATCH "+a.bold+" COMPLETED. ").yellow.inverse)},"js")});gulp.watch([b+"/fonts/**/*"],function(d){buildBundle(a,function(){console.log("         √ ".green+(" WATCH "+a.bold+" COMPLETED. ").yellow.inverse)},"resource")})}gulp.task("watch",function(b){var a=process.argv[3]||"dist";if(a&&a[0]==="-"){a=a.substr(1)}startWatchSrc(a)});["dist","doc","theme","lib"].forEach(function(b){var a=(b=="dist"||b=="doc")?["minJSON"]:[];gulp.task(b,a,function(c){console.log("  BEGIN >> "+(" Build "+b.bold+" ").inverse);buildBundle(b=="lib"?"seperate":b,function(){console.log("    END >> "+(" Build "+b.bold+" completed. ").green.inverse);c()})});gulp.task("watch:"+b,function(){startWatchSrc(b)})});gulp.task("minJSON",function(a){gulp.src(["./docs/index.json","./docs/icons.json"]).pipe(jsonminify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("./docs/"));gulp.src(["zui.json"]).pipe(jsonminify()).pipe(rename({suffix:".min"})).pipe(gulp.dest("./docs/"));a()});gulp.task("prettify:js",function(){return gulp.src("./src/js/**/*").pipe(prettify({logSuccess:true,config:"./.jsbeautifyrc",mode:"VERIFY_AND_WRITE"})).pipe(gulp.dest("./src/js/"))});gulp.task("prettify",["prettify:js"]);gulp.task("default",function(){buildBundle("all")});if(isFileExist("gulpfile.custom.js")){require("./gulpfile.custom.js")(gulp,{chmod:chmod,less:less,cssmin:cssmin,csscomb:csscomb,autoprefixer:autoprefixer,concat:concat,header:header,uglify:uglify,rename:rename,change:change,sourcemaps:sourcemaps,prettify:prettify,buildBundle:buildBundle,zui:zui,pkg:pkg,del:del,mkdirp:mkdirp,runSequence:runSequence})};