var MergePage=(function(){function a(f,d,c){var i=this;this.$table=$("#page-table").loading();this.$pageForm=$("#pageForm").on("submit",function(){var j=i.formParams();i.$pageForm.find('input[name="currencyId"]').val(j.currencyId);i.$pageForm.find('input[name="year"]').val(j.year);i.$pageForm.find('input[name="month"]').val(j.month);i.$pageForm.find('input[name="divideYear"]').val(j.divideYear);i.$pageForm.find('input[name="divideMonth"]').val(j.divideMonth);i.$pageForm.find('input[name="divideDay"]').val(j.divideDay)});this.currencies=[{id:"g111W2qibFUfXSub6MEEJ",name:"恒逸汇总（人民币）"},{id:"g1zTboj6D3ddaXJrvm5AF",name:"恒逸汇总（美元）"},{id:"SSmTiaVKUe6xy37VZmacWj",name:"恒逸汇总（承兑汇票）"}];this.date=moment(d);this.divideDate=moment(c);this.weekDatas=J.generateMonthWeeks(this.date).map(function(k,j){return new MergeWeekData(i,k,j+1)});$("#year-month").datetimepicker(J.dtp({initialDate:this.date.toDate(),startView:"year",minView:"year"})).on("changeDate",function(j){var k=moment(j.date);if(i.date.isSame(k,"month")){return}i.date=k;i.$pageForm.submit()});$("#divide-date").datetimepicker(J.dtp({initialDate:this.divideDate.toDate()})).on("changeDate",function(j){var k=moment(j.date);if(i.divideDate.isSame(k,"day")){return}i.divideDate=k;i.$pageForm.submit()});var b=$("#currency-list");var e=function(j){if(j.id===f){i.currency=j}return $('<a href="javascript:">'+j.name+"</a>").on("click",function(){if(i.currency.id===j.id){return}i.currency=j;i.$pageForm.submit()})};this.currencies.forEach(function(j){var k=$("<li></li>").appendTo(b);e(j).appendTo(k)});this.currency=this.currency||this.currencies[0];$("#currency").text(this.currency.name);var h=J.listReportsSumSumTypes().then(function(j){return i.sumTypes=j});var g=J.listReportsSumBalances(this.formParams()).then(function(j){i.balances=j;i.corporationMap=i.balances.reduce(function(k,m){var l=m.corporation;k[l.id]=l;return k},{})});$.when(h,g).then(function(){i.weekDatas.forEach(function(j){return j.fillData()});J.generateWeekScrolls($("#divide-date").parent(),i.$table.parent(),i.weekDatas);i.$table.loading("toggle")})}a.prototype.formParams=function(){return{currencyId:this.currency&&this.currency.id,year:this.date.year(),month:this.date.month()+1,divideYear:this.divideDate.year(),divideMonth:this.divideDate.month()+1,divideDay:this.divideDate.date()}};a.prototype.monthAdd=function(b){if(b===void 0){b=1}this.date=moment(this.date).add(b,"M");this.divideDate=moment();this.$pageForm.submit()};a.prototype.dblclickSumType=function(){this.weekDatas.forEach(function(b){b.corporationTrs.forEach(function(c){return c.toggle()})})};a.prototype.exportCurrentXlsx=function(){J.exportSumReportsXlsx(this.formParams())};a.prototype.exportAllXlsx=function(){var b=this.formParams();delete b.currencyId;J.exportSumReportsXlsx(b)};return a}());var MergeWeekData=(function(){function a(c,d,b){this.page=c;this.dates=d;this.index=b;this.corporationTrsMap={};this.domId="week-"+b}Object.defineProperty(a.prototype,"corporationTrs",{get:function(){var b=this;return Object.keys(this.corporationTrsMap).map(function(c){return b.corporationTrsMap[c]}).reduce(function(c,d){return c.concat(d)},[])},enumerable:true,configurable:true});a.prototype.fillData=function(){var d=this;this.dayDatas=this.dates.map(function(e){return new MergeDayData(d.page,e)});var b=[$('<tr id="'+this.domId+'"><th rowspan="2" class="week-index">第'+this.index+"周</th></tr>"),$("<tr></tr>"),$("<tr><th>日期</th></tr>")].map(function(e){return e.appendTo(d.page.$table)});J.WEEK_DAYS.forEach(function(f,e){$('<th class="week-day">'+f+"</th>").appendTo(b[0]);$("<th>金额</th>").appendTo(b[1]);var g=d.dates[e].isSame(d.page.date,"month")?d.dates[e].date()+"号":"";$('<th class="week-day">'+g+"</th>").appendTo(b[2])});this.page.sumTypes.forEach(function(f){if(f.corporationIds){f.corporationIds.map(function(g){return d.page.corporationMap[g]}).filter(function(g){return g}).forEach(function(i){var g=$("<tr><td>"+i.name+"</td></tr>").appendTo(d.page.$table);d.dayDatas.forEach(function(j){g.append(j.corporationTd(i.id,f))});var h=d.corporationTrsMap[f.type]||[];h.push(g);d.corporationTrsMap[f.type]=h})}var e=$("<tr><td>"+f.name+"</td></tr>").appendTo(d.page.$table).on("dblclick",function(){d.page.dblclickSumType()});switch(f.type){case"SS":case"FSS":e.addClass("balance_2");break;default:e.addClass("balance_1");break}d.dayDatas.forEach(function(g){e.append(g.sumTypeTd(f))})});var c=$('<tr class="balance_3"><td> 本日余额总计</td></tr>').appendTo(this.page.$table).on("dblclick",function(){d.page.dblclickSumType()});this.dayDatas.forEach(function(e){c.append(e.todayBalanceTd())})};return a}());var MergeDayData=(function(){function a(c,b){var d=this;this.page=c;this.date=b;this.balanceMap={};this.todayBalance=0;this.dateInMonth=this.date.isSame(this.page.date,"month");if(!this.dateInMonth){return}this.balances=this.page.balances.filter(function(e){return d.date.isSame(moment(e.date),"day")})}a.prototype.corporationTd=function(g,e){var f=this;var d=$("<td></td>");if(this.dateInMonth){var c=0;this.balances.forEach(function(h){if(h.corporation.id===g){c=h.balance;d.text(J.renderMoney(h.balance)).addClass("money");if(!f.date.isBefore(f.page.divideDate,"day")){d.addClass("divide")}}});this.todayBalance+=c;var b=this.balanceMap[e.type]||0;b+=c;this.balanceMap[e.type]=b}return d};a.prototype.sumTypeTd=function(d){var e=this;var c=$("<td></td>");if(this.dateInMonth){var b=this.balanceMap[d.type];if(!b){b=0;Object.keys(this.balanceMap).forEach(function(f){if(f.indexOf(d.type)===0){b+=e.balanceMap[f]}})}c.text(J.renderMoney(b)).addClass("money")}return c};a.prototype.todayBalanceTd=function(){var b=$("<td></td>");if(this.dateInMonth){b.text(J.renderMoney(this.todayBalance)).addClass("money")}return b};return a}());