var DailyPage=(function(){function a(e,d,c,b){var f=this;this.$table=$("#page-table").loading();this.fundUpdateModal=new FundUpdateModal(this);this.batchFundUpdateModal=new BatchFundUpdateModal(this);this.$pageForm=$("#pageForm").on("submit",function(){var g=f.formParams();f.$pageForm.find('input[name="corporationId"]').val(g.corporationId);f.$pageForm.find('input[name="currencyId"]').val(g.currencyId);f.$pageForm.find('input[name="year"]').val(g.year);f.$pageForm.find('input[name="month"]').val(g.month);f.$pageForm.find('input[name="divideYear"]').val(g.divideYear);f.$pageForm.find('input[name="divideMonth"]').val(g.divideMonth);f.$pageForm.find('input[name="divideDay"]').val(g.divideDay)});this.date=moment(c);this.divideDate=moment(b);this.weekDatas=J.generateMonthWeeks(this.date).map(function(h,g){return new DailyWeekData(f,h,g+1)});$("#year-month").datetimepicker(J.dtp({initialDate:this.date.toDate(),startView:"year",minView:"year"})).on("changeDate",function(g){var h=moment(g.date);if(f.date.isSame(h,"month")){return}f.date=h;f.$pageForm.submit()});$("#divide-date").datetimepicker(J.dtp({initialDate:this.divideDate.toDate()})).on("changeDate",function(g){var h=moment(g.date);if(f.divideDate.isSame(h,"day")){return}f.divideDate=h;f.$pageForm.submit()});J.listCorporation().then(function(z){var q=z.sort(function(A,i){return i.sortBy-A.sortBy});var m=$("#corporation-list");var x=function(i){if(i.id===e){f.corporation=i}return $('<a href="javascript:">'+i.name+"</a>").on("click",function(){if(f.corporation.id===i.id){return}f.corporation=i;f.$pageForm.submit()})};var l=J.calcRowsCols(q.length),s=l[0],t=l[1];if(t===1){q.forEach(function(i){var A=$("<li></li>").appendTo(m);x(i).appendTo(A)})}else{m.addClass("dropdown-menu-table");var h=$('<table class="table table-bordered"></table>').appendTo(m);for(var p=0;p<s;p++){var y=$("<tr></tr>").appendTo(h);for(var k=0;k<t;k++){var n=$("<td></td>").appendTo(y);var u=p*t+k;if(u<q.length){x(q[u]).appendTo(n)}}}}f.corporation=f.corporation||q[0];$("#corporation").text(f.corporation.name);var v=f.corporation.currencies.sort(function(A,i){return i.sortBy-A.sortBy});var r=$("#currency-list");var o=function(i){if(i.id===d){f.currency=i}return $('<a href="javascript:">'+i.name+"</a>").on("click",function(){if(f.currency.id===i.id){return}f.currency=i;f.$pageForm.submit()})};v.forEach(function(i){var A=$("<li></li>").appendTo(r);o(i).appendTo(A)});f.currency=f.currency||v[0];$("#currency").text(f.currency.name);var w=f.formParams();var j=J.listBalance(w).then(function(i){return f.balances=i});var g=J.listFundlike(w).then(function(i){return f.funds=i});return $.when(j,g)}).then(function(){f.weekDatas.forEach(function(g){return g.fillData()});J.generateWeekScrolls($("#divide-date").parent(),f.$table.parent(),f.weekDatas);f.$table.loading("toggle")})}a.prototype.refresh=function(){var e=this;this.$table.loading();var d=this.formParams();var c=J.listBalance(d).then(function(f){return e.balances=f});var b=J.listFundlike(d).then(function(f){return e.funds=f});$.when(c,b).then(function(){var f=e.$table.parent();var g=f.scrollTop();e.$table.empty();e.weekDatas.forEach(function(h){return h.fillData()});f.scrollTop(g);e.$table.loading("toggle")})};a.prototype.monthAdd=function(b){if(b===void 0){b=1}this.date=moment(this.date).add(b,"M");this.divideDate=moment();this.$pageForm.submit()};a.prototype.createBatchFund=function(){this.batchFundUpdateModal.show()};a.prototype.exportCurrentXlsx=function(){J.exportXlsx(this.formParams())};a.prototype.exportAllXlsx=function(){var b=this.formParams();delete b.corporationId;delete b.currencyId;J.exportXlsx(b)};a.prototype.formParams=function(){return{corporationId:this.corporation&&this.corporation.id,currencyId:this.currency&&this.currency.id,year:this.date.year(),month:this.date.month()+1,divideYear:this.divideDate.year(),divideMonth:this.divideDate.month()+1,divideDay:this.divideDate.date()}};return a}());var DailyWeekData=(function(){function a(c,d,b){this.page=c;this.dates=d;this.index=b;this.domId="week-"+b}a.prototype.fillData=function(){var g=this;this.dayDatas=this.dates.map(function(i){return new DailyDayData(g.page,i)});var f=[$('<tr id="'+this.domId+'"><th rowspan="2" class="week-index">第'+this.index+"周</th></tr>"),$("<tr></tr>"),$("<tr><th>日期</th></tr>")].map(function(i){return i.appendTo(g.page.$table)});J.WEEK_DAYS.forEach(function(p,o){$('<th colspan="2" class="week-day">'+p+"</th>").appendTo(f[0]);$("<th>金额</th>").appendTo(f[1]);$("<th>简述</th>").appendTo(f[1]);var q=g.dates[o].isSame(g.page.date,"month")?g.dates[o].date()+"号":"";$('<th colspan="2" class="week-day">'+q+"</th>").appendTo(f[2])});var j=$('<tr class="balance_1"><td>上日余额</td></tr>').appendTo(this.page.$table);this.dayDatas.forEach(function(i){i.preBalanceTds().forEach(function(o){return j.append(o)})});var n=this.dayDatas.reduce(function(i,o){return Math.max(i,o.outFundsCount())},0);var d=function(o){var p=$("<tr><td>支出"+(o+1)+"</td></tr>").appendTo(m.page.$table);m.dayDatas.forEach(function(i){i.outFundTds(o).forEach(function(q){return p.append(q)})})};var m=this;for(var e=0;e<=n;e++){d(e)}var c=$('<tr class="balance_2"><td>资金余缺</td></tr>').appendTo(this.page.$table);this.dayDatas.forEach(function(i){i.lackBalanceTds().forEach(function(o){return c.append(o)})});var h=this.dayDatas.reduce(function(i,o){return Math.max(i,o.inFundsCount())},0);var b=function(o){var p=$("<tr><td>收入"+(o+1)+"</td></tr>").appendTo(l.page.$table);l.dayDatas.forEach(function(i){i.inFundTds(o).forEach(function(q){return p.append(q)})})};var l=this;for(var e=0;e<=h;e++){b(e)}var k=$('<tr class="balance_3"><td>本日余额</td></tr>').appendTo(this.page.$table);this.dayDatas.forEach(function(i){i.todayBalanceTds().forEach(function(o){return k.append(o)})})};return a}());var DailyDayData=(function(){function a(f,d){var g=this;this.page=f;this.date=d;this.outFunds=[];this.inFunds=[];this.dateInMonth=this.date.isSame(this.page.date,"month");if(!this.dateInMonth){return}var c=0;var b=0;this.page.funds.filter(function(h){return g.date.isSame(h.date,"day")}).forEach(function(h){if(h.money>0){g.inFunds.push(h);b+=h.money}else{g.outFunds.push(h);c+=h.money}});var e=moment(this.date).add(-1,"d");this.page.balances.forEach(function(h){if(g.date.isSame(h.date,"day")){g.todayBalance=h.balance}else{if(e.isSame(h.date,"day")){g.preBalance=h.balance}}});if(!this.preBalance){this.preBalance=this.todayBalance-b-c}this.lackBalance=this.preBalance+c;this.calcTodayBalance=this.preBalance+b+c}a.prototype.preBalanceTds=function(){return this.balanceTds(this.preBalance)};a.prototype.lackBalanceTds=function(){return this.balanceTds(this.lackBalance)};a.prototype.todayBalanceTds=function(){return this.balanceTds(this.todayBalance)};a.prototype.outFundTds=function(b){return this.fundTds(this.outFunds,b)};a.prototype.outFundsCount=function(){return this.outFunds?this.outFunds.length:0};a.prototype.inFundTds=function(b){return this.fundTds(this.inFunds,b)};a.prototype.inFundsCount=function(){return this.inFunds?this.inFunds.length:0};a.prototype.balanceTds=function(c){var b=[$("<td></td>"),$("<td></td>")];var d=b[0];if(this.dateInMonth&&c){d.text(J.renderMoney(c)).addClass("money")}return b};a.prototype.fundTds=function(f,e){var h=this;var b=[$("<td></td>"),$("<td></td>")];var d=b[0],c=b[1];var g=f&&f[e];if(g){d.text(J.renderMoney(g.money)).addClass("money");c.text(g.note).addClass("note text-ellipsis").attr("title",g.note)}if(this.dateInMonth){b.forEach(function(i){i.on("dblclick",function(){return h.page.fundUpdateModal.show(g,h.date)})});if(!this.date.isBefore(this.page.divideDate,"day")){d.addClass("divide");c.addClass("divide")}}return b};return a}());var BatchFundUpdateModal=(function(){function a(c){var e=this;this.page=c;this.$modal=$("#batchFundUpdateModal");this.$form=this.$modal.find("form");this.$startDate=this.$form.find('input[name="startDate"]');this.$endDate=this.$form.find('input[name="endDate"]');this.$monthFundPlanList=this.$form.find('select[name="monthFundPlanId"]');this.$note=this.$form.find('textarea[name="note"]');this.$moneyDisplay=this.$form.find("#batch-money-show");this.$money=this.$form.find('input[name="money"]').on("input propertychange",function(){var f=e.$money.val();e.$moneyDisplay.text($.formatMoney(f))});this.$save=this.$modal.find('button[name="save"]').on("click",function(){J.createBatchFundlike(e.$monthFundPlanList.val(),{startDate:moment(e.$startDate.val()).toDate(),endDate:moment(e.$endDate.val()).toDate(),money:e.$money.val(),note:e.$note.val()}).then(function(){e.page.refresh();e.$modal.modal("hide")})});var b=moment(this.page.date);this.$startDate.val(b.format("YYYY-MM-DD"));this.$startDate.datetimepicker(J.dtp({initialDate:b.toDate()})).on("changeDate",function(f){e.$endDate.datetimepicker("setStartDate",f.date)});var d=moment(b).add(1,"M").add(-1,"d");this.$endDate.val(d.format("YYYY-MM-DD"));this.$endDate.datetimepicker(J.dtp({initialDate:d.toDate()}))}a.prototype.show=function(){var b=this;J.listMonthFundPlans({corporationId:this.page.corporation.id,currencyId:this.page.currency.id,year:this.page.date.year(),month:this.page.date.month()+1}).then(function(c){b.$monthFundPlanList.empty();c.forEach(function(d){$('<option value="'+d.id+'">'+d.purpose.name+"</option>").appendTo(b.$monthFundPlanList)});b.$monthFundPlanList.val(c[0].id);b.$money.val("");b.$money.trigger("input");b.$note.val("");b.$modal.modal({moveable:true,rememberPos:true})})};return a}());var FundUpdateModal=(function(){function a(b){var c=this;this.page=b;this.$modal=$("#fundUpdateModal");this.$modalTitle=this.$modal.find(".modal-title");this.$form=$("#fundUpdateForm");this.$date=this.$form.find('input[name="date"]').datetimepicker(J.dtp({maxView:"year"}));this.$monthFundPlanList=this.$form.find('select[name="monthFundPlanId"]');this.$moneyDisplay=this.$form.find("#money-show");this.$note=this.$form.find('textarea[name="note"]');this.$money=this.$form.find('input[name="money"]').on("input propertychange",function(){var d=c.$money.val();c.$moneyDisplay.text($.formatMoney(d))});this.$save=this.$modal.find('button[name="save"]').on("click",function(){$.extend(c.fund,{date:moment(c.$date.val()).toDate(),money:c.$money.val(),note:c.$note.val()});J.saveFundlike(c.$monthFundPlanList.val(),c.fund).then(function(){c.page.refresh();c.$modal.modal("hide")})});this.$delete=this.$modal.find('button[name="delete"]').on("click",function(){if(!confirm("删除确认？")){return}J.deleteFundlike(c.fund.id).then(function(){c.page.refresh();c.$modal.modal("hide")})})}a.prototype.show=function(b,c){var d=this;J.listMonthFundPlans({corporationId:this.page.corporation.id,currencyId:this.page.currency.id,year:this.page.date.year(),month:this.page.date.month()+1}).then(function(e){d.$monthFundPlanList.empty();e.forEach(function(f){$('<option value="'+f.id+'">'+f.purpose.name+"</option>").appendTo(d.$monthFundPlanList)});if(b&&b.id){d.fund=$.extend({},b);d.$modalTitle.text("更新");d.$delete.show()}else{d.fund={monthFundPlan:e[0],date:c};d.$modalTitle.text("新增");d.$delete.hide()}d.$date.val(moment(d.fund.date).format("YYYY-MM-DD"));d.$monthFundPlanList.val(d.fund.monthFundPlan.id);d.$money.val(d.fund.money);d.$money.trigger("input");d.$note.val(d.fund.note);d.$modal.modal({moveable:true,rememberPos:true})})};return a}());